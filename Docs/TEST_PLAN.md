# Terminal Phone — Test Plan

## Strategy

Three test layers:

1. **Unit tests** — Pure Python logic (config parsing, header pipeline, state
   machines). No PJSIP, no network. Fast.
2. **Integration tests** — Real pjsua2 against Asterisk in Docker. Actual SIP
   signaling on loopback. Slower but proves it works.
3. **TUI smoke tests** — Textual's built-in `pilot` test framework for
   simulating key presses and checking widget state.

## Test Environment

### Asterisk Docker Container

```yaml
# docker-compose.test.yml
services:
  asterisk:
    image: andrius/asterisk:latest   # or build our own
    ports:
      - "5060:5060/udp"
      - "5060:5060/tcp"
      - "5061:5061/tcp"              # TLS
      - "10000-10100:10000-10100/udp"  # RTP
    volumes:
      - ./test/asterisk/sip.conf:/etc/asterisk/sip.conf
      - ./test/asterisk/pjsip.conf:/etc/asterisk/pjsip.conf
      - ./test/asterisk/extensions.conf:/etc/asterisk/extensions.conf
      - ./test/asterisk/voicemail.conf:/etc/asterisk/voicemail.conf
```

### Asterisk Test Config (pjsip.conf)

```ini
; test/asterisk/pjsip.conf
[transport-udp]
type=transport
protocol=udp
bind=0.0.0.0:5060

[transport-tcp]
type=transport
protocol=tcp
bind=0.0.0.0:5060

; Test extensions 100-110
[100]
type=endpoint
context=testing
disallow=all
allow=ulaw,alaw,g722,opus
auth=100
aors=100

[100]
type=auth
auth_type=userpass
username=100
password=test100

[100]
type=aor
max_contacts=5
remove_existing=yes

; Repeat for 101-110...
; (generated by test fixture script)
```

### Asterisk Dialplan (extensions.conf)

```ini
[testing]
; Echo test - plays back what you say
exten => 600,1,Answer()
 same => n,Echo()

; Playback test - plays MOH
exten => 601,1,Answer()
 same => n,MusicOnHold(default)

; DTMF test - reads digits and plays them back
exten => 602,1,Answer()
 same => n,Read(digits,,4)
 same => n,SayDigits(${digits})
 same => n,Hangup()

; Auto-answer test
exten => 603,1,Set(PJSIP_HEADER(add,Alert-Info)=auto-answer)
 same => n,Dial(PJSIP/${EXTEN})

; Transfer target
exten => 700,1,Answer()
 same => n,Playback(tt-monkeys)
 same => n,Hangup()

; Extension-to-extension
exten => _1XX,1,Dial(PJSIP/${EXTEN},30)
 same => n,Hangup()

; Voicemail
exten => _1XX,1,Dial(PJSIP/${EXTEN},15)
 same => n,VoiceMail(${EXTEN}@default)

; Conference
exten => 800,1,Answer()
 same => n,ConfBridge(1)
```

## Unit Tests

### Config Parser
```
test_config_load_minimal        - Loads config with one account
test_config_load_multi_account  - Loads config with multiple accounts
test_config_defaults            - Missing optional fields get defaults
test_config_invalid_transport   - Rejects invalid transport value
test_config_blf_list            - Parses BLF subscription list
test_config_header_overrides    - Parses per-account header overrides
test_config_codec_priority      - Parses codec priority list
```

### Header Pipeline
```
test_header_apply_all_methods   - method_filter=None applies to everything
test_header_apply_invite_only   - method_filter="INVITE" skips REGISTER
test_header_one_shot_removed    - One-shot header removed after first use
test_header_persistent_survives - Persistent header stays across requests
test_header_from_config         - Headers loaded from TOML config
test_header_runtime_override    - Runtime override takes precedence
```

### State Machine
```
test_call_state_outbound_flow   - idle→calling→early→confirmed→disconnected
test_call_state_inbound_flow    - idle→incoming→confirmed→disconnected
test_call_state_hold_resume     - confirmed→hold→confirmed
test_call_state_rejected        - incoming→disconnected
test_reg_state_flow             - unregistered→registering→registered
test_reg_state_failure          - unregistered→registering→failed
test_blf_state_mapping          - dialog-info XML → idle/ringing/busy/offline
```

## Integration Tests

All integration tests use a pytest fixture that:
1. Starts the Asterisk Docker container (or reuses a running one)
2. Waits for Asterisk to be ready (SIP port responding)
3. Creates a SipEngine with test account configs
4. Tears down after tests

### Registration
```
test_register_success           - Register ext 100 → RegStateEvent(registered)
test_register_wrong_password    - Bad password → RegStateEvent(failed, 401)
test_register_unreachable       - Bad server → RegStateEvent(failed, timeout)
test_unregister                 - Unregister → RegStateEvent(unregistered)
test_register_multi_account     - Register 100 + 101 simultaneously
test_register_expiry_refresh    - Wait for re-REGISTER before expiry
```

### Basic Calling
```
test_outbound_call_echo         - Call 600 (echo) → confirmed → hangup
test_outbound_call_cancel       - Call 601 → cancel before answer
test_inbound_call_answer        - 101 calls 100, 100 answers, both hangup
test_inbound_call_reject        - 101 calls 100, 100 rejects → 486
test_inbound_call_ignore        - 101 calls 100, 100 ignores, timeout
test_call_caller_id             - Verify remote_uri in CallStateEvent
test_call_duration_tracking     - Call 600 for 3s, check duration ~3s
```

### Call Features
```
test_hold_resume                - Call 600, hold, check media, resume, hangup
test_mute_unmute                - Call 600, mute, verify no audio path, unmute
test_dtmf_rfc4733               - Call 602, send "1234", verify digits received
test_blind_transfer             - 100 calls 101, 100 blind xfers to 102
test_attended_transfer          - 100 calls 101, 100 calls 102, xfer 101→102
test_three_way_conference       - 100 calls 101 + 102, bridges audio
```

### BLF Subscriptions
```
test_blf_subscribe              - Subscribe to ext 101 → get idle state
test_blf_ringing                - Subscribe to 101, call 101 → ringing state
test_blf_busy                   - 101 answers call → busy/confirmed state
test_blf_idle_after_hangup      - Call ends → back to idle state
test_blf_multi_extension        - Subscribe to 101,102,103 simultaneously
test_blf_unsubscribe            - Unsubscribe → no more state events
```

### MWI
```
test_mwi_no_messages            - Subscribe → MwiEvent(new=0, old=0)
test_mwi_new_voicemail          - Leave voicemail for 100 → MwiEvent(new=1)
```

### Header Overrides
```
test_custom_user_agent          - Set UA to "Yealink", check SIP trace
test_custom_header_in_invite    - Add X-Foo, verify in sent INVITE trace
test_from_display_name          - Override display name, verify in From header
```

### Transport
```
test_udp_transport              - Register + call over UDP
test_tcp_transport              - Register + call over TCP
test_tls_transport              - Register + call over TLS (needs certs)
```

### SIP Trace
```
test_trace_captures_register    - SipTraceEvent captured for REGISTER
test_trace_captures_invite      - SipTraceEvent captured for INVITE
test_trace_direction             - Verify send vs recv direction
```

## SIP Dialog Viewer Tests

### Unit: SIP Parser
```
test_parse_invite_request       - Extract method, uri, headers from INVITE
test_parse_200_response         - Extract status code, reason, headers
test_parse_call_id              - Extract Call-ID from any message
test_parse_cseq                 - Extract CSeq number and method
test_parse_from_to              - Extract From/To URIs and tags
test_parse_multiline_header     - Handle folded headers correctly
test_parse_sdp_body             - Detect and preserve SDP body
```

### Unit: Dialog Tracker
```
test_new_invite_creates_dialog  - First INVITE creates a dialog entry
test_responses_grouped          - 100/180/200 grouped under same Call-ID
test_bye_terminates_dialog      - BYE transitions dialog to terminated
test_subscribe_tracked          - SUBSCRIBE creates separate dialog type
test_notify_grouped             - NOTIFY grouped with its SUBSCRIBE
test_dialog_state_machine       - trying→early→confirmed→terminated
test_multiple_dialogs           - Concurrent dialogs tracked independently
```

### Unit: Ladder Diagram
```
test_ladder_basic_call          - INVITE/200/ACK/BYE renders correct arrows
test_ladder_direction            - Arrows point correct direction per src/dst
test_ladder_timestamps          - Timestamps shown on each message
test_ladder_early_media         - 183 shown between INVITE and 200
```

### Integration
```
test_dialog_viewer_register     - REGISTER dialog captured and displayed
test_dialog_viewer_call         - Full call flow captured in ladder
test_dialog_viewer_blf          - SUBSCRIBE/NOTIFY dialog tracked
test_dialog_viewer_filter       - Filter by INVITE-only shows calls
```

## TUI Tests (Textual Pilot)

Textual has a built-in test framework (`app.run_test()`) that simulates
input without needing a real terminal.

```
test_app_launches               - App starts without crash
test_dial_input_focus           - Press 'd', dial input gets focus
test_dial_and_call              - Type number, press Enter, call initiated
test_hangup_key                 - Press 'h' during call, hangup fires
test_answer_key                 - Incoming call, press 'a', answer fires
test_mute_toggle                - Press 'm', mute state toggles
test_tab_switching              - Tab key switches bottom panels
test_blf_panel_displays         - BLF entries show in panel
test_sip_trace_scrolls          - SIP trace messages appear in log
test_reg_status_updates         - Registration state reflected in account list
test_settings_screen            - F2 opens settings, Escape closes
test_header_editor              - F3 opens header editor modal
```

## CI Pipeline

```yaml
# .github/workflows/test.yml
jobs:
  unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - run: pip install -e '.[test]'
      - run: pytest tests/unit/ -v

  integration:
    runs-on: ubuntu-latest
    services:
      asterisk:
        image: andrius/asterisk:latest
        ports: ['5060:5060/udp', '5060:5060/tcp']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - run: pip install -e '.[test]'
      - run: pytest tests/integration/ -v --timeout=60

  tui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - run: pip install -e '.[test]'
      - run: pytest tests/tui/ -v
```

## Test Helpers

```python
# tests/conftest.py

@pytest.fixture(scope="session")
def asterisk():
    """Start Asterisk container, yield when ready, stop after."""
    container = start_asterisk_container()
    wait_for_sip_port("localhost", 5060, timeout=30)
    yield container
    container.stop()

@pytest.fixture
def engine(asterisk):
    """Fresh SipEngine connected to test Asterisk."""
    eng = SipEngine(event_callback=collect_events)
    eng.start(test_config())
    yield eng
    eng.stop()

@pytest.fixture
def two_phones(asterisk):
    """Two registered phones (100 and 101) for call testing."""
    phone_a = make_phone("100", "test100")
    phone_b = make_phone("101", "test101")
    yield phone_a, phone_b
    phone_a.stop()
    phone_b.stop()

def wait_for_event(engine, event_type, timeout=10, **match):
    """Block until an event of the given type with matching fields appears."""
    ...
```
